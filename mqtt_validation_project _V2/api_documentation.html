<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Dokümantasyonu: HTTP & WebSocket</title>
    <!-- Modern Font ve İkonlar -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Kod renklendirme için Prism.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-color: #2c2c2c;
            --text-color: #f0f0f0;
            --primary-color: #4ecca3;
            --secondary-color: #3b3b3b;
            --border-color: #444;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.7;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }
        header {
            text-align: center;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 2rem;
            margin-bottom: 2rem;
        }
        header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        header p {
            font-size: 1.2rem;
            color: #ccc;
        }
        .card {
            background-color: var(--card-color);
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        h2 {
            font-size: 1.8rem;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        h3 {
            font-size: 1.5rem;
            color: #ddd;
            margin-bottom: 2rem;
        }
        code {
            background-color: var(--secondary-color);
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-size: 0.9em;
        }
        pre[class*="language-"] {
            padding: 1.5em;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            font-size: 0.95em;
        }
        .api-endpoint {
            border-top: 1px solid var(--border-color);
            padding-top: 1.5rem;
            margin-top: 1.5rem;
        }
        .api-endpoint:first-of-type {
            border-top: none;
            padding-top: 0;
            margin-top: 0;
        }
        .api-endpoint h4 {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.2rem;
            background-color: var(--secondary-color);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            display: inline-block;
            margin-top: 0;
        }
        .api-endpoint h5 {
            font-size: 1.1rem;
            color: #ccc;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .api-endpoint ol {
            list-style: decimal;
            padding-left: 20px;
        }
        .api-endpoint ol li {
            padding: 0.5rem 0;
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="ph-bold ph-plugs-connected"></i> API Dokümantasyonu</h1>
            <p>HTTP Endpoints ve WebSocket Arayüzü</p>
        </header>

        <main>
            <section class="card">
                <h2><i class="ph ph-radio-button"></i> REST API Endpoints</h2>
                <p>
                    Bu bölümde, sistemin dinamik yapısını yönetmek için kullanılan tüm HTTP API endpoint'leri detaylı olarak açıklanmaktadır. Tüm <code>GET</code> endpoint'leri, tarayıcı önbelleklemesini engellemek için <code>Cache-Control: no-store</code> başlığı ile yanıt verir.
                </p>
            </section>

            <!-- MQTT Settings Endpoints -->
            <section class="card">
                <h3><i class="ph ph-broadcast"></i> MQTT Ayarları</h3>

                <div class="api-endpoint">
                    <h4><code>GET /api/mqtt-settings</code></h4>
                    <p><strong>Açıklama:</strong> Mevcut MQTT broker ayarlarını (URL ve port) alır.</p>
                    <p><strong>Başarılı Yanıt (200 OK):</strong></p>
                    <pre><code class="language-json">{
  "broker": "broker.hivemq.com",
  "port": 1883
}</code></pre>
                    <h5>Kod Analizi (<code>main.py</code>)</h5>
                    <pre><code class="language-python">@app.get("/api/mqtt-settings")
async def get_mqtt_settings():
    config = read_config()
    return JSONResponse(content=config.get("mqtt_settings", {}), headers={"Cache-Control": "no-store"})</code></pre>
                    <ol>
                        <li><strong>Fonksiyon Tanımı:</strong> <code>/api/mqtt-settings</code> adresine bir <code>GET</code> isteği geldiğinde bu asenkron fonksiyon çalışır.</li>
                        <li><strong>Konfigürasyonu Oku:</strong> <code>read_config()</code> yardımcı fonksiyonu ile <code>config.json</code> dosyasının içeriği okunur.</li>
                        <li><strong>Yanıt Döndürme:</strong> <code>JSONResponse</code> olarak, konfigürasyon dosyasındaki <code>mqtt_settings</code> anahtarının değeri döndürülür. Yanıta <code>Cache-Control: no-store</code> başlığı eklenir.</li>
                    </ol>
                </div>

                <div class="api-endpoint">
                    <h4><code>POST /api/mqtt-settings</code></h4>
                    <p><strong>Açıklama:</strong> MQTT broker ayarlarını günceller. Bu işlem, değişikliğin tüm sisteme yansıması için MQTT istemcisini yeniden başlatır ve WebSocket üzerinden bir bildirim gönderir.</p>
                    <p><strong>Örnek İstek Gövdesi (JSON):</strong></p>
                    <pre><code class="language-json">{
  "broker": "test.mosquitto.org",
  "port": 1883
}</code></pre>
                    <p><strong>Başarılı Yanıt (200 OK):</strong></p>
                    <pre><code class="language-json">{ "message": "MQTT settings updated successfully." }</code></pre>
                    <h5>Kod Analizi (<code>main.py</code>)</h5>
                    <pre><code class="language-python">@app.post("/api/mqtt-settings")
async def update_mqtt_settings(settings: MqttSettings):
    config = read_config()
    config["mqtt_settings"] = settings.dict()
    write_config(config)
    restart_mqtt_client()
    await manager.broadcast("config_updated")
    return {"message": "MQTT settings updated successfully."}</code></pre>
                    <ol>
                        <li><strong>Veri Doğrulama:</strong> FastAPI, gelen JSON gövdesini otomatik olarak <code>MqttSettings</code> Pydantic modeline göre doğrular.</li>
                        <li><strong>Konfigürasyonu Güncelle ve Yaz:</strong> Mevcut <code>config.json</code> okunur, <code>mqtt_settings</code> anahtarı yeni verilerle güncellenir ve diske geri yazılır.</li>
                        <li><strong>Sistemi Yenile:</strong> <code>restart_mqtt_client()</code> fonksiyonu çağrılarak backend'deki MQTT istemcisi yeni ayarlarla yeniden başlatılır.</li>
                        <li><strong>Bildirim Gönder:</strong> <code>await manager.broadcast("config_updated")</code> komutu ile WebSocket üzerinden tüm dashboard'lara bir güncelleme olduğu bildirilir.</li>
                    </ol>
                </div>
            </section>

            <!-- Topic Mappings Endpoints -->
            <section class="card">
                <h3><i class="ph ph-arrows-split"></i> Konu Eşleştirme (Topic Mapping) Ayarları</h3>
                <div class="api-endpoint">
                    <h4><code>GET /api/topic-mappings</code></h4>
                    <p><strong>Açıklama:</strong> Tanımlanmış tüm konu eşleştirme kurallarını bir liste olarak döndürür.</p>
                    <p><strong>Başarılı Yanıt (200 OK):</strong></p>
                    <pre><code class="language-json">[
  {
    "source": "/sensor1",
    "validated": "/sensor1/validated",
    "failed": "/sensor1/failed",
    "schema": "schemas/sensor1.json"
  }
]</code></pre>
                    <h5>Kod Analizi (<code>main.py</code>)</h5>
                    <pre><code class="language-python">@app.get("/api/topic-mappings")
async def get_topic_mappings():
    config = read_config()
    return JSONResponse(content=config.get("topic_mappings", []), headers={"Cache-Control": "no-store"})</code></pre>
                    <ol>
                        <li><strong>Konfigürasyonu Oku:</strong> <code>config.json</code> dosyasının içeriği okunur.</li>
                        <li><strong>Yanıt Döndürme:</strong> <code>topic_mappings</code> anahtarının değeri (bir liste) <code>JSONResponse</code> olarak döndürülür.</li>
                    </ol>
                </div>

                <div class="api-endpoint">
                    <h4><code>POST /api/topic-mappings</code></h4>
                    <p><strong>Açıklama:</strong> Tüm konu eşleştirme listesini günceller. Mevcut listeyi, istek gövdesinde gönderilen yeni liste ile tamamen değiştirir.</p>
                    <p><strong>Örnek İstek Gövdesi (JSON):</strong></p>
                    <pre><code class="language-json">[
  {
    "source": "/sensor1",
    "validated": "/sensor1/validated",
    "failed": "/sensor1/failed",
    "schema": "schemas/sensor1.json"
  },
  {
    "source": "/sensor_new",
    "validated": "/sensor_new/valid",
    "failed": "/sensor_new/invalid",
    "schema": "schemas/new.json"
  }
]</code></pre>
                    <h5>Kod Analizi (<code>main.py</code>)</h5>
                    <pre><code class="language-python">@app.post("/api/topic-mappings")
async def update_topic_mappings(mappings: List[TopicMapping]):
    config = read_config()
    config["topic_mappings"] = [m.dict() for m in mappings]
    write_config(config)
    restart_mqtt_client()
    await manager.broadcast("config_updated")
    return {"message": "Topic mappings updated successfully."}</code></pre>
                     <ol>
                        <li><strong>Veri Doğrulama:</strong> FastAPI, gelen JSON listesindeki her bir objeyi <code>TopicMapping</code> Pydantic modeline göre doğrular.</li>
                        <li><strong>Konfigürasyonu Güncelle ve Yaz:</strong> Mevcut <code>config.json</code> okunur, <code>topic_mappings</code> listesi yeni liste ile tamamen değiştirilir ve diske yazılır.</li>
                        <li><strong>Sistemi Yenile ve Bildir:</strong> MQTT istemcisi yeniden başlatılır ve WebSocket üzerinden değişiklik duyurulur.</li>
                    </ol>
                </div>
            </section>
            
            <!-- Schema Management Endpoints -->
            <section class="card">
                <h3><i class="ph ph-scroll"></i> Şema Yönetimi</h3>
                 <div class="api-endpoint">
                    <h4><code>GET /api/schemas</code></h4>
                    <p><strong>Açıklama:</strong> <code>schemas</code> klasöründeki tüm <code>.json</code> uzantılı dosyaların listesini döndürür.</p>
                    <h5>Kod Analizi (<code>main.py</code>)</h5>
                    <pre><code class="language-python">@app.get("/api/schemas")
async def get_all_schema_files():
    # ...
    schema_files = [f"schemas/{f.name}" for f in SCHEMAS_DIR.glob("*.json")]
    return JSONResponse(content=schema_files, headers={"Cache-control": "no-store"})</code></pre>
                </div>

                 <div class="api-endpoint">
                    <h4><code>POST /api/schemas</code></h4>
                    <p><strong>Açıklama:</strong> Yeni bir şema dosyası oluşturur.</p>
                     <p><strong>Örnek İstek Gövdesi (JSON):</strong></p>
                    <pre><code class="language-json">{
  "filename": "sensor4.json",
  "content": { "columns": {}, "strict": true }
}</code></pre>
                    <h5>Kod Analizi (<code>main.py</code>)</h5>
                    <pre><code class="language-python">@app.post("/api/schemas", status_code=201)
async def create_new_schema_file(item: SchemaFile):
    file_path = SCHEMAS_DIR / item.filename
    if not item.filename.endswith(".json"):
        raise HTTPException(status_code=400, detail="Filename must end with .json")
    if file_path.exists():
        raise HTTPException(status_code=400, detail="File already exists.")
    
    with open(file_path, "w") as f:
        json.dump(item.content, f, indent=2)
    return {"message": f"Schema file '{item.filename}' created."}</code></pre>
                    <ol>
                        <li><strong>Güvenlik Kontrolü:</strong> Dosya adının <code>.json</code> ile bittiği ve aynı isimde başka bir dosyanın mevcut olmadığı kontrol edilir.</li>
                        <li><strong>Dosya Yazma:</strong> Gelen içerik, <code>schemas/</code> dizini altına yeni bir dosyaya JSON formatında yazılır.</li>
                    </ol>
                </div>

                <div class="api-endpoint">
                    <h4><code>GET /api/schemas/{filename}</code></h4>
                    <p><strong>Açıklama:</strong> Belirtilen şema dosyasının içeriğini JSON olarak döndürür.</p>
                </div>

                <div class="api-endpoint">
                    <h4><code>PUT /api/schemas/{filename}</code></h4>
                    <p><strong>Açıklama:</strong> Mevcut bir şema dosyasının içeriğini günceller.</p>
                </div>

                 <div class="api-endpoint">
                    <h4><code>DELETE /api/schemas/{filename}</code></h4>
                    <p><strong>Açıklama:</strong> Belirtilen şema dosyasını siler.</p>
                </div>
            </section>

            <section class="card">
                <h2><i class="ph ph-wave-sine"></i> WebSocket API</h2>
                 <div class="api-endpoint">
                    <h4><code>GET /ws/config-updates</code></h4>
                    <p><strong>Açıklama:</strong> Sunucu ile çift yönlü bir iletişim kanalı kurar. Sunucu, herhangi bir konfigürasyon değişikliği olduğunda (MQTT, Topic Mappings veya Şema ayarları değiştiğinde) bu kanaldan <code>"config_updated"</code> metnini yayınlar. Bu mesajı alan Dashboard (<code>app.js</code>), kendini en güncel ayarlarla yeniden başlatır.</p>
                     <h5>Kod Analizi (<code>main.py</code>)</h5>
                    <pre><code class="language-python">@app.websocket("/ws/config-updates")
async def websocket_endpoint(websocket: WebSocket):
    await manager.connect(websocket)
    try:
        while True:
            await websocket.receive_text() # Sadece bağlantıyı canlı tutmak için
    except WebSocketDisconnect:
        manager.disconnect(websocket)</code></pre>
                    <ol>
                        <li><strong>Bağlantı Kurma:</strong> Bir istemci bu adrese bağlandığında, <code>ConnectionManager</code> sınıfı tarafından yönetilen bağlantı havuzuna eklenir.</li>
                        <li><strong>Bağlantıyı Canlı Tutma:</strong> Sunucu, bağlantı kopana kadar istemciden gelebilecek mesajları dinler (bu projede istemciden mesaj beklenmez, sadece dinleme yapılır).</li>
                        <li><strong>Yayınlama (Broadcast):</strong> Başka bir API endpoint'i (örn: <code>/api/mqtt-settings</code>) <code>await manager.broadcast("config_updated")</code> komutunu çağırdığında, <code>ConnectionManager</code> bu mesajı havuzdaki tüm aktif bağlantılara gönderir.</li>
                    </ol>
                </div>
            </section>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html> 