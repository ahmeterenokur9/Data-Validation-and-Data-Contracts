<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT Validator - Admin</title>
    <link rel="stylesheet" href="/static/admin.css?v=1.2">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>
<body>
    <div class="container">
        <h1><i class="ph ph-wrench"></i> Admin Panel</h1>

        <!-- MQTT Configuration -->
        <div class="card">
            <h2><i class="ph ph-broadcast"></i> MQTT Configuration</h2>
            <form id="mqtt-config-form">
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div><label for="broker">Broker URL</label><input type="text" id="broker"></div>
                    <div><label for="port">Port</label><input type="number" id="port"></div>
                </div>
                <hr>
                <h3>Topic Mappings</h3>
                <div id="mappings-list"></div>
                <button type="button" id="add-mapping-btn" class="add-btn"><i class="ph ph-plus"></i> Add New Mapping</button>
                <hr>
                <button type="submit" id="save-config-btn">Save Configuration</button>
            </form>
            <p id="config-status" class="status-message hidden"></p>
        </div>

        <!-- Schema File Editor -->
        <div class="card">
            <h2><i class="ph ph-scroll"></i> Schema File Editor</h2>
            <div class="schema-layout">
                <div class="schema-list-container">
                    <h3>Available Schemas</h3>
                    <table id="schemas-table">
                        <thead><tr><th>Filename</th><th>Action</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <button type="button" id="new-schema-btn" class="add-btn" style="margin-top: 16px;"><i class="ph ph-plus"></i> Create New</button>
                </div>
                <div class="schema-editor-container" id="schema-editor-container">
                    <h3 id="editor-title">Schema Editor</h3>
                    <form id="schema-editor-form">
                        <div class="form-group">
                            <label for="schema-filename">Filename</label>
                            <input type="text" id="schema-filename" required placeholder="new-schema.json">
                        </div>
                        <div class="form-group">
                            <label for="schema-content">Schema Content (JSON)</label>
                            <textarea id="schema-content" required></textarea>
                        </div>
                        <button type="submit">Save Schema File</button>
                        <button type="button" id="cancel-edit-btn" class="delete-btn">Cancel</button>
                    </form>
                    <p id="schema-status" class="status-message hidden"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let availableSchemas = [];
            let isEditMode = false;
            let currentEditingFilename = null;

            const configStatus = document.getElementById('config-status');
            const mappingsList = document.getElementById('mappings-list');
            const schemasTableBody = document.querySelector('#schemas-table tbody');
            const schemaEditorContainer = document.getElementById('schema-editor-container');
            const schemaEditorForm = document.getElementById('schema-editor-form');
            const editorTitle = document.getElementById('editor-title');
            const schemaFilenameInput = document.getElementById('schema-filename');
            const schemaContentTextarea = document.getElementById('schema-content');
            const schemaStatus = document.getElementById('schema-status');

            async function apiCall(url, options = {}) {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }
                return response.json();
            }

            function showStatus(element, message, isSuccess) {
                element.textContent = message;
                element.className = `status-message ${isSuccess ? 'success' : 'error'}`;
                element.classList.remove('hidden');
                setTimeout(() => element.classList.add('hidden'), 5000);
            }

            async function loadInitialConfig() {
                try {
                    const [settings, mappings, schemas] = await Promise.all([
                        apiCall('/api/mqtt-settings'),
                        apiCall('/api/topic-mappings'),
                        apiCall('/api/schemas')
                    ]);
                    availableSchemas = schemas;
                    document.getElementById('broker').value = settings.broker || '';
                    document.getElementById('port').value = settings.port || '';
                    renderMappings(mappings);
                    renderSchemaFileList(schemas);
                } catch (error) {
                    showStatus(configStatus, `Error loading config: ${error.message}`, false);
                }
            }

            function renderMappings(mappings = []) {
                mappingsList.innerHTML = '';
                mappings.forEach((mapping, index) => {
                    mappingsList.appendChild(createMappingItem(mapping, index));
                });
            }

            function createMappingItem(mapping, index) {
                const div = document.createElement('div');
                div.className = 'mapping-item';
                const schemaOptions = availableSchemas.map(s => `<option value="${s}" ${s === mapping.schema ? 'selected' : ''}>${s.split('/').pop()}</option>`).join('');
                div.innerHTML = `
                    <div class="mapping-header"><h4>Mapping #${index + 1}</h4><button type="button" class="delete-btn delete-mapping-btn"><i class="ph ph-trash"></i></button></div>
                    <div class="mapping-fields" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px;">
                        <div class="form-group"><label>Source Topic</label><input type="text" class="mapping-source" value="${mapping.source || ''}"></div>
                        <div class="form-group"><label>Validated Topic</label><input type="text" class="mapping-validated" value="${mapping.validated || ''}"></div>
                        <div class="form-group"><label>Failed Topic</label><input type="text" class="mapping-failed" value="${mapping.failed || ''}"></div>
                        <div class="form-group"><label>Schema</label><select class="mapping-schema"><option value="">- None -</option>${schemaOptions}</select></div>
                    </div>`;
                return div;
            }

            function renderSchemaFileList(schemas = []) {
                schemasTableBody.innerHTML = '';
                schemas.forEach(schemaPath => {
                    const filename = schemaPath.split('/').pop();
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${filename}</td><td><button class="edit-btn" data-filename="${filename}">Edit</button><button class="delete-btn" data-filename="${filename}">Delete</button></td>`;
                    schemasTableBody.appendChild(row);
                });
            }

            function showSchemaEditor(isNew, filename = '') {
                isEditMode = isNew ? false : true;
                currentEditingFilename = isNew ? null : filename;
                editorTitle.textContent = isNew ? 'Create New Schema File' : `Editing: ${filename}`;
                schemaFilenameInput.value = isNew ? '' : filename;
                schemaFilenameInput.readOnly = !isNew;
                if (isNew) {
                    schemaContentTextarea.value = '{\n    "columns": {},\n    "strict": true,\n    "coerce": true\n}';
                }
                schemaEditorContainer.style.display = 'block';
            }

            function hideSchemaEditor() {
                schemaEditorContainer.style.display = 'none';
                schemaEditorForm.reset();
            }

            document.getElementById('mqtt-config-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const settings = {
                    broker: document.getElementById('broker').value,
                    port: parseInt(document.getElementById('port').value, 10)
                };
                const mappingElements = mappingsList.querySelectorAll('.mapping-item');
                const mappings = Array.from(mappingElements).map(item => ({
                    source: item.querySelector('.mapping-source').value.trim(),
                    validated: item.querySelector('.mapping-validated').value.trim(),
                    failed: item.querySelector('.mapping-failed').value.trim(),
                    schema: item.querySelector('.mapping-schema').value
                })).filter(m => m.source);

                try {
                    await apiCall('/api/topic-mappings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(mappings) });
                    await apiCall('/api/mqtt-settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(settings) });
                    showStatus(configStatus, 'Configuration saved successfully!', true);
                } catch (error) {
                    showStatus(configStatus, `Failed to save configuration: ${error.message}`, false);
                }
            });

            document.getElementById('add-mapping-btn').addEventListener('click', () => {
                mappingsList.appendChild(createMappingItem({}, mappingsList.children.length));
            });

            mappingsList.addEventListener('click', (e) => {
                if (e.target.closest('.delete-mapping-btn')) {
                    e.target.closest('.mapping-item').remove();
                }
            });

            document.getElementById('new-schema-btn').addEventListener('click', () => showSchemaEditor(true));
            document.getElementById('cancel-edit-btn').addEventListener('click', hideSchemaEditor);
            
            schemasTableBody.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const filename = button.dataset.filename;
                
                if (button.classList.contains('edit-btn')) {
                    apiCall(`/api/schemas/${filename}`).then(content => {
                        showSchemaEditor(false, filename);
                        schemaContentTextarea.value = JSON.stringify(content, null, 4);
                    }).catch(err => showStatus(schemaStatus, err.message, false));
                } else if (button.classList.contains('delete-btn')) {
                    if (confirm(`Are you sure you want to delete "${filename}"?`)) {
                        apiCall(`/api/schemas/${filename}`, { method: 'DELETE' }).then(() => {
                            showStatus(schemaStatus, `"${filename}" deleted.`, true);
                            loadInitialConfig();
                        }).catch(err => showStatus(schemaStatus, err.message, false));
                    }
                }
            });

            schemaEditorForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const filename = schemaFilenameInput.value.trim();
                let content;
                try {
                    content = JSON.parse(schemaContentTextarea.value);
                } catch (err) {
                    showStatus(schemaStatus, 'Invalid JSON.', false); return;
                }
                
                const url = isEditMode ? `/api/schemas/${currentEditingFilename}` : '/api/schemas';
                const method = isEditMode ? 'PUT' : 'POST';
                const body = isEditMode ? content : { filename, content };

                try {
                    await apiCall(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                    showStatus(schemaStatus, `Schema "${filename}" saved.`, true);
                    loadInitialConfig();
                    hideSchemaEditor();
                } catch (err) {
                    showStatus(schemaStatus, err.message, false);
                }
            });

            loadInitialConfig();
        });
    </script>
</body>
</html> 