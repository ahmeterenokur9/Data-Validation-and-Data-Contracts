<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT Validator - Admin</title>
    <link rel="stylesheet" href="/static/admin.css?v=1.2">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>
<body>
    <div class="container">
        <h1><i class="ph ph-wrench"></i> Admin Panel</h1>

        <!-- MQTT Configuration -->
        <div class="card">
            <h2><i class="ph ph-broadcast"></i> MQTT Configuration</h2>
            <form id="mqtt-config-form">
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div><label for="broker">Broker URL</label><input type="text" id="broker"></div>
                    <div><label for="port">Port</label><input type="number" id="port"></div>
                </div>
                <hr>
                <h3>Topic Mappings</h3>
                <div id="mappings-list"></div>
                <button type="button" id="add-mapping-btn" class="add-btn"><i class="ph ph-plus"></i> Add New Mapping</button>
                <hr>
                <button type="submit" id="save-config-btn">Save Configuration</button>
            </form>
            <p id="config-status" class="status-message hidden"></p>
        </div>

        <!-- Schema File Editor -->
        <div class="card">
            <h2><i class="ph ph-scroll"></i> Schema File Editor</h2>
            <div class="schema-layout">
                <div class="schema-list-container">
                    <h3>Available Schemas</h3>
                    <table id="schemas-table">
                        <thead><tr><th>Filename</th><th>Action</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <button type="button" id="new-schema-btn" class="add-btn" style="margin-top: 16px;"><i class="ph ph-plus"></i> Create New</button>
                </div>
                <div class="schema-editor-container" id="schema-editor-container">
                    <h3 id="editor-title">Schema Editor</h3>

                    <div class="editor-toggle">
                        <button id="visual-editor-btn" class="toggle-btn active" type="button">Visual Editor</button>
                        <button id="raw-editor-btn" class="toggle-btn" type="button">Raw Text (JSON)</button>
                    </div>

                    <form id="schema-editor-form">
                        <div class="form-group">
                            <label for="schema-filename">Filename</label>
                            <input type="text" id="schema-filename" required placeholder="new-schema.json">
                        </div>

                        <!-- Visual Editor Content -->
                        <div id="visual-editor">
                            <!-- General Schema Settings -->
                            <div class="schema-settings">
                                <h4>General Schema Settings</h4>
                                <div class="form-group inline">
                                    <input type="checkbox" id="schema-strict">
                                    <label for="schema-strict">Strict Mode (No extra columns allowed)</label>
                                </div>
                                <div class="form-group inline">
                                    <input type="checkbox" id="schema-ordered">
                                    <label for="schema-ordered">Ordered (Columns must be in schema order)</label>
                                </div>
                                <div class="form-group inline">
                                    <input type="checkbox" id="schema-coerce">
                                    <label for="schema-coerce">Coerce Types (Attempt to convert types)</label>
                                </div>
                            </div>

                            <!-- Columns Container -->
                            <h4>Columns</h4>
                            <div id="columns-container"></div>
                            <button type="button" id="add-column-btn" class="add-btn"><i class="ph ph-plus-circle"></i> Add Column</button>
                        </div>

                        <!-- Raw Text Editor Content -->
                        <div id="raw-editor" style="display: none;">
                             <div class="form-group">
                                <label for="schema-content-raw">Content (JSON format)</label>
                                <textarea id="schema-content-raw" rows="15" placeholder="Enter schema as strict JSON..."></textarea>
                            </div>
                        </div>
                        
                        <hr>

                        <div class="form-actions">
                            <button type="submit" id="save-schema-btn" class="save-btn">Save Schema</button>
                            <button type="button" id="cancel-edit-btn" class="delete-btn">Cancel</button>
                        </div>
                    </form>
                    <p id="schema-status" class="status-message hidden"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Template for a new column -->
    <template id="column-template">
        <div class="column-card">
            <div class="column-header">
                <input type="text" class="column-name" placeholder="Column Name" required>
                <button type="button" class="delete-btn delete-column-btn"><i class="ph ph-trash"></i></button>
            </div>
            <div class="column-body">
                <div class="form-group">
                    <label>Data Type</label>
                    <select class="column-dtype">
                        <option value="str">String</option>
                        <option value="int">Integer</option>
                        <option value="float">Float</option>
                        <option value="bool">Boolean</option>
                        <option value="datetime">DateTime</option>
                    </select>
                </div>
                <div class="form-group inline">
                    <input type="checkbox" class="column-nullable">
                    <label>Nullable (Can be empty)</label>
                </div>
                <div class="form-group inline">
                    <input type="checkbox" class="column-unique">
                    <label>Unique</label>
                </div>
                <div class="column-checks-wrapper">
                    <h5>Checks</h5>
                    <div class="checks-container">
                        <!-- Checks will be dynamically added here -->
                    </div>
                    <button type="button" class="add-btn add-check-btn"><i class="ph ph-plus"></i> Add Check</button>
                </div>
            </div>
        </div>
    </template>

    <!-- Template for a new check -->
    <template id="check-template">
        <div class="check-item">
            <select class="check-type">
                <optgroup label="Common">
                    <option value="greater_than">greater_than</option>
                    <option value="less_than">less_than</option>
                    <option value="greater_than_or_equal_to">greater_than_or_equal_to</option>
                    <option value="less_than_or_equal_to">less_than_or_equal_to</option>
                    <option value="equal_to">equal_to</option>
                    <option value="not_equal_to">not_equal_to</option>
                </optgroup>
                <optgroup label="String">
                    <option value="str_matches">str_matches (Regex)</option>
                    <option value="str_contains">str_contains</option>
                    <option value="str_starts_with">str_starts_with</option>
                    <option value="str_ends_with">str_ends_with</option>
                    <option value="str_length">str_length</option>
                </optgroup>
                 <optgroup label="Numeric">
                    <option value="in_range">in_range</option>
                </optgroup>
            </select>
            <input type="text" class="check-value" placeholder="Value (e.g., 10 or [0, 100])">
            <button type="button" class="delete-btn delete-check-btn"><i class="ph ph-x"></i></button>
        </div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let availableSchemas = [];
            let isEditMode = false;
            let currentEditingFilename = null;

            const configStatus = document.getElementById('config-status');
            const mappingsList = document.getElementById('mappings-list');
            const schemasTableBody = document.querySelector('#schemas-table tbody');
            const schemaEditorContainer = document.getElementById('schema-editor-container');
            const schemaEditorForm = document.getElementById('schema-editor-form');
            const editorTitle = document.getElementById('editor-title');
            const schemaFilenameInput = document.getElementById('schema-filename');
            const schemaStatus = document.getElementById('schema-status');

            // Editor Mode Elements
            let currentEditorMode = 'visual'; // 'visual' or 'raw'
            const visualEditorBtn = document.getElementById('visual-editor-btn');
            const rawEditorBtn = document.getElementById('raw-editor-btn');
            const visualEditor = document.getElementById('visual-editor');
            const rawEditor = document.getElementById('raw-editor');
            const schemaContentRaw = document.getElementById('schema-content-raw');

            // New Schema Builder Elements
            const columnsContainer = document.getElementById('columns-container');
            const addColumnBtn = document.getElementById('add-column-btn');
            const columnTemplate = document.getElementById('column-template');
            const checkTemplate = document.getElementById('check-template');

            // --- UI LOGIC ---

            function addColumn(columnData = {}) {
                const columnCard = columnTemplate.content.cloneNode(true).firstElementChild;
                
                // Populate fields if data is provided (for editing)
                columnCard.querySelector('.column-name').value = columnData.name || '';
                if (columnData.dtype) columnCard.querySelector('.column-dtype').value = columnData.dtype;
                columnCard.querySelector('.column-nullable').checked = columnData.nullable || false;
                columnCard.querySelector('.column-unique').checked = columnData.unique || false;
                
                const checksContainer = columnCard.querySelector('.checks-container');
                if (columnData.checks) {
                    for (const [type, value] of Object.entries(columnData.checks)) {
                        addCheck(checksContainer, { type, value });
                    }
                }

                columnsContainer.appendChild(columnCard);
            }

            function addCheck(container, checkData = {}) {
                const checkItem = checkTemplate.content.cloneNode(true).firstElementChild;
                if (checkData.type) checkItem.querySelector('.check-type').value = checkData.type;
                
                // Handle array values for 'in_range'
                if (checkData.type === 'in_range' && Array.isArray(checkData.value)) {
                     checkItem.querySelector('.check-value').value = JSON.stringify(checkData.value);
                } else {
                    checkItem.querySelector('.check-value').value = checkData.value || '';
                }

                container.appendChild(checkItem);
            }

            function buildSchemaJsonFromForm() {
                const schema = { columns: {} };
                
                // General settings
                schema.strict = document.getElementById('schema-strict').checked;
                schema.ordered = document.getElementById('schema-ordered').checked;
                schema.coerce = document.getElementById('schema-coerce').checked;

                columnsContainer.querySelectorAll('.column-card').forEach(card => {
                    const name = card.querySelector('.column-name').value.trim();
                    if (!name) return; // Skip empty columns

                    const column = {
                        dtype: card.querySelector('.column-dtype').value,
                        nullable: card.querySelector('.column-nullable').checked,
                        unique: card.querySelector('.column-unique').checked,
                        checks: {}
                    };

                    card.querySelectorAll('.check-item').forEach(item => {
                        const type = item.querySelector('.check-type').value;
                        let value = item.querySelector('.check-value').value;
                        
                        // Try to parse value as number or boolean if not a string check
                        if (!type.startsWith('str_')) {
                            try { value = JSON.parse(value); } catch (e) { /* keep as string */ }
                        }
                        
                        column.checks[type] = value;
                    });
                    
                    if (Object.keys(column.checks).length === 0) {
                        delete column.checks;
                    }

                    schema.columns[name] = column;
                });

                return schema;
            }

            function populateFormFromJson(schema) {
                // Clear existing form
                columnsContainer.innerHTML = '';

                if (!schema) return;

                // Populate general settings
                document.getElementById('schema-strict').checked = schema.strict || false;
                document.getElementById('schema-ordered').checked = schema.ordered || false;
                document.getElementById('schema-coerce').checked = schema.coerce || false;

                // Populate columns
                if (schema.columns) {
                    for (const [name, data] of Object.entries(schema.columns)) {
                        addColumn({ name, ...data });
                    }
                }
            }
            
            function switchToVisual() {
                try {
                    const content = schemaContentRaw.value.trim();
                    if (!content) {
                        // If the raw editor is empty, just switch without error, maybe populate with a default.
                        populateFormFromJson({ strict: true, columns: {} });
                    } else {
                        const schemaJson = JSON.parse(content);
                        populateFormFromJson(schemaJson);
                    }
                    
                    visualEditor.style.display = 'block';
                    rawEditor.style.display = 'none';
                    visualEditorBtn.classList.add('active');
                    rawEditorBtn.classList.remove('active');
                    currentEditorMode = 'visual';
                } catch (e) {
                    showStatus(schemaStatus, `Invalid JSON in raw editor. Please fix before switching. Error: ${e.message}`, false);
                }
            }

            function switchToRaw() {
                const schemaJson = buildSchemaJsonFromForm();
                schemaContentRaw.value = JSON.stringify(schemaJson, null, 4);

                rawEditor.style.display = 'block';
                visualEditor.style.display = 'none';
                rawEditorBtn.classList.add('active');
                visualEditorBtn.classList.remove('active');
                currentEditorMode = 'raw';
            }


            // --- API & DATA LOGIC ---

            async function apiCall(url, options = {}) {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }
                return response.json();
            }

            function showStatus(element, message, isSuccess) {
                element.textContent = message;
                element.className = `status-message ${isSuccess ? 'success' : 'error'}`;
                element.classList.remove('hidden');
                setTimeout(() => element.classList.add('hidden'), 5000);
            }

            async function loadInitialConfig() {
                try {
                    const [settings, mappings, schemas] = await Promise.all([
                        apiCall('/api/mqtt-settings'),
                        apiCall('/api/topic-mappings'),
                        apiCall('/api/schemas')
                    ]);
                    availableSchemas = schemas;
                    document.getElementById('broker').value = settings.broker || '';
                    document.getElementById('port').value = settings.port || '';
                    renderMappings(mappings);
                    renderSchemaFileList(schemas);
                } catch (error) {
                    showStatus(configStatus, `Error loading config: ${error.message}`, false);
                }
            }

            function renderMappings(mappings = []) {
                mappingsList.innerHTML = '';
                mappings.forEach((mapping, index) => {
                    mappingsList.appendChild(createMappingItem(mapping, index));
                });
            }

            function createMappingItem(mapping, index) {
                const div = document.createElement('div');
                div.className = 'mapping-item';
                const schemaOptions = availableSchemas.map(s => `<option value="${s}" ${s === mapping.schema ? 'selected' : ''}>${s.split('/').pop()}</option>`).join('');
                div.innerHTML = `
                    <div class="mapping-header"><h4>Mapping #${index + 1}</h4><button type="button" class="delete-btn delete-mapping-btn"><i class="ph ph-trash"></i></button></div>
                    <div class="mapping-fields" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px;">
                        <div class="form-group"><label>Source Topic</label><input type="text" class="mapping-source" value="${mapping.source || ''}"></div>
                        <div class="form-group"><label>Validated Topic</label><input type="text" class="mapping-validated" value="${mapping.validated || ''}"></div>
                        <div class="form-group"><label>Failed Topic</label><input type="text" class="mapping-failed" value="${mapping.failed || ''}"></div>
                        <div class="form-group"><label>Schema</label><select class="mapping-schema"><option value="">- None -</option>${schemaOptions}</select></div>
                    </div>`;
                return div;
            }

            function renderSchemaFileList(schemas = []) {
                schemasTableBody.innerHTML = '';
                schemas.forEach(schemaPath => {
                    const filename = schemaPath.split('/').pop();
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${filename}</td><td><button class="edit-btn" data-filename="${filename}">Edit</button><button class="delete-btn" data-filename="${filename}">Delete</button></td>`;
                    schemasTableBody.appendChild(row);
                });
            }

            function showSchemaEditor(isNew, filename = '') {
                isEditMode = !isNew;
                currentEditingFilename = isNew ? null : filename;
                editorTitle.textContent = isNew ? 'Create New Schema' : `Editing: ${filename}`;
                schemaFilenameInput.value = isNew ? '' : filename;
                schemaFilenameInput.readOnly = !isNew;
                
                if (isNew) {
                    // Start with a clean slate for the form
                    populateFormFromJson({
                        strict: true,
                        coerce: false,
                        ordered: false,
                        columns: {
                            "sensor_id": { "dtype": "str", "nullable": false },
                            "timestamp": { "dtype": "str", "nullable": false }
                        }
                    });
                }
                schemaEditorContainer.style.display = 'block';
            }

            function hideSchemaEditor() {
                schemaEditorContainer.style.display = 'none';
                schemaEditorForm.reset();
                columnsContainer.innerHTML = ''; // Clear dynamic columns
            }

            document.getElementById('mqtt-config-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const settings = {
                    broker: document.getElementById('broker').value,
                    port: parseInt(document.getElementById('port').value, 10)
                };
                const mappingElements = mappingsList.querySelectorAll('.mapping-item');
                const mappings = Array.from(mappingElements).map(item => ({
                    source: item.querySelector('.mapping-source').value.trim(),
                    validated: item.querySelector('.mapping-validated').value.trim(),
                    failed: item.querySelector('.mapping-failed').value.trim(),
                    schema: item.querySelector('.mapping-schema').value
                })).filter(m => m.source);

                try {
                    await apiCall('/api/topic-mappings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(mappings) });
                    await apiCall('/api/mqtt-settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(settings) });
                    showStatus(configStatus, 'Configuration saved successfully!', true);
                } catch (error) {
                    showStatus(configStatus, `Failed to save configuration: ${error.message}`, false);
                }
            });

            document.getElementById('add-mapping-btn').addEventListener('click', () => {
                mappingsList.appendChild(createMappingItem({}, mappingsList.children.length));
            });

            mappingsList.addEventListener('click', (e) => {
                if (e.target.closest('.delete-mapping-btn')) {
                    e.target.closest('.mapping-item').remove();
                }
            });

            document.getElementById('new-schema-btn').addEventListener('click', () => showSchemaEditor(true));
            document.getElementById('cancel-edit-btn').addEventListener('click', hideSchemaEditor);
            
            schemasTableBody.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const filename = button.dataset.filename;
                
                if (button.classList.contains('edit-btn')) {
                    apiCall(`/api/schemas/${filename}`).then(content => {
                        showSchemaEditor(false, filename);
                        // Populate both editors initially
                        populateFormFromJson(content);
                        schemaContentRaw.value = JSON.stringify(content, null, 4);
                        // Default to visual editor
                        switchToVisual();
                    }).catch(err => showStatus(schemaStatus, err.message, false));
                } else if (button.classList.contains('delete-btn')) {
                    if (confirm(`Are you sure you want to delete "${filename}"?`)) {
                        apiCall(`/api/schemas/${filename}`, { method: 'DELETE' }).then(() => {
                            showStatus(schemaStatus, `"${filename}" deleted.`, true);
                            loadInitialConfig();
                        }).catch(err => showStatus(schemaStatus, err.message, false));
                    }
                }
            });

            schemaEditorForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const filename = schemaFilenameInput.value.trim();
                if (!filename) {
                    showStatus(schemaStatus, 'Filename is required.', false);
                    return;
                }
                
                let schemaContentStr;

                if (currentEditorMode === 'visual') {
                    const schemaJson = buildSchemaJsonFromForm();
                    schemaContentStr = JSON.stringify(schemaJson);
                } else { // raw mode
                    schemaContentStr = schemaContentRaw.value;
                    // Now, we do a client-side check for valid JSON before sending
                    try {
                        JSON.parse(schemaContentStr);
                    } catch (e) {
                        showStatus(schemaStatus, `Save failed: Content is not valid JSON. Error: ${e.message}`, false);
                        return; // Stop the submission
                    }
                }

                const url = isEditMode ? `/api/schemas/${filename}` : '/api/schemas';
                const method = isEditMode ? 'PUT' : 'POST';
                
                let finalBody = schemaContentStr;
                // For POST, the backend expects a different structure {filename, content}
                // The content here is now a string that the backend will parse
                if (!isEditMode) {
                    finalBody = JSON.stringify({ filename, content: schemaContentStr });
                }

                fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: finalBody })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw new Error(err.detail || 'An unknown error occurred'); });
                        }
                        return response.json();
                    })
                    .then(result => {
                        showStatus(schemaStatus, result.message, true);
                        loadInitialConfig();
                        hideSchemaEditor();
                    })
                    .catch(err => {
                        showStatus(schemaStatus, `Save failed: ${err.message}`, false);
                    });
            });
            
            // --- DYNAMIC FORM EVENT LISTENERS ---
            
            visualEditorBtn.addEventListener('click', switchToVisual);
            rawEditorBtn.addEventListener('click', switchToRaw);
            
            addColumnBtn.addEventListener('click', () => addColumn());

            columnsContainer.addEventListener('click', e => {
                if (e.target.closest('.delete-column-btn')) {
                    e.target.closest('.column-card').remove();
                } else if (e.target.closest('.add-check-btn')) {
                    const checksContainer = e.target.closest('.column-card').querySelector('.checks-container');
                    addCheck(checksContainer);
                } else if (e.target.closest('.delete-check-btn')) {
                    e.target.closest('.check-item').remove();
                }
            });
            
            // Show/hide checks based on dtype
            columnsContainer.addEventListener('change', e => {
                if (e.target.classList.contains('column-dtype')) {
                    const columnCard = e.target.closest('.column-card');
                    const checksWrapper = columnCard.querySelector('.column-checks-wrapper');
                    if (e.target.value === 'datetime') {
                        checksWrapper.style.display = 'none';
                    } else {
                        checksWrapper.style.display = 'block';
                    }
                }
            });

            loadInitialConfig();
        });
    </script>
</body>
</html> 